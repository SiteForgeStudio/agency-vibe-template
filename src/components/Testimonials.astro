---
/**
 * COMPONENT: Testimonials
 * Logic: Safe asset discovery for avatars to prevent 404s.
 */
 import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';

const { testimonials } = Astro.props;

// 1. ASSET DISCOVERY
const images = import.meta.glob<{ default: ImageMetadata }>('/src/assets/images/*.{jpeg,jpg,png,gif,webp}');

if (!testimonials || testimonials.length === 0) return null;
---

<section id="testimonials" class="py-24 bg-[var(--bg-card)] border-y border-[var(--border)]">
  <div class="container mx-auto px-6">
    <div class="text-center mb-16">
      <h2 class="text-xs font-bold tracking-[0.3em] uppercase text-[var(--accent)] mb-4">Social Proof</h2>
      <h3 class="text-4xl md:text-6xl font-black uppercase tracking-tighter text-[var(--text-primary)]">
        Client <span class="text-[var(--accent)]">Intel</span>
      </h3>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
      {testimonials.map((t: any) => {
        // Safe check for the image in assets
        const imagePath = t.avatar?.startsWith('/src') ? t.avatar : `/src/assets/images/${t.avatar?.split('/').pop()}`;
        const hasAvatar = images[imagePath];

        return (
          <div class="bg-[var(--bg-color)] border border-[var(--border)] p-8 rounded-[var(--radius)] relative overflow-hidden">
            <div class="flex items-center gap-4 mb-6">
              {hasAvatar ? (
                <Image 
                  src={images[imagePath]()} 
                  alt={t.name} 
                  width={100} 
                  height={100} 
                  class="w-12 h-12 rounded-full object-cover border border-[var(--accent)]"
                />
              ) : (
                /* Fallback: Initials instead of a broken 404 image */
                <div class="w-12 h-12 rounded-full bg-[var(--bg-card)] border border-[var(--border)] flex items-center justify-center text-[var(--accent)] font-bold text-xs">
                  {t.name.charAt(0)}
                </div>
              )}
              <div>
                <h4 class="text-sm font-bold uppercase tracking-widest text-[var(--text-primary)]">{t.name}</h4>
                <p class="text-[10px] uppercase tracking-widest text-[var(--accent)] font-bold">{t.role}</p>
              </div>
            </div>
            
            <p class="text-[var(--text-secondary)] text-sm leading-relaxed italic opacity-80">
              "{t.content}"
            </p>
            
            <div class="absolute top-4 right-8 text-6xl font-serif text-[var(--accent)] opacity-10 select-none">â€œ</div>
          </div>
        );
      })}
    </div>
  </div>
</section>