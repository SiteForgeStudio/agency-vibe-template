---
import { Image } from 'astro:assets';
const { gallery, brand } = Astro.props;

// 1. ASSET DISCOVERY
// This scans your images folder so Astro can optimize them at build time.
const images = import.meta.glob<{ default: ImageMetadata }>('/src/assets/images/*.{jpeg,jpg,png,gif,webp}');

// 2. THE SLUG HANDSHAKE
// Standardized slug generation to match your fetch-unsplash-images.mjs output.
const brandSlug =
  brand?.slug ||
  (brand?.name || 'brand')
    .toLowerCase()
    .replace(/'/g, '')
    .replace(/[^a-z0-9]/g, '-');

// 3. RESILIENT GUARD
// We no longer require gallery.items to exist to render.
const items = Array.isArray(gallery?.items) ? gallery.items : [];
const count = gallery?.computed_count || items.length || 0;

// Only hide if the gallery is explicitly disabled or there is no intended count/data.
if (!gallery || gallery.enabled === false || (items.length === 0 && count === 0)) {
  return null;
}

// 4. DATA PREPARATION
// If the AI provided a count but no items array, we create a skeleton array.
// This ensures {visibleItems.map} actually runs even with an empty base JSON.
const visibleItems = items.length > 0 
  ? items.slice(0, count) 
  : Array.from({ length: count }).map((_, i) => ({ title: `Project ${i + 1}` }));

const title = gallery.title || 'Portfolio';
const layout = gallery.computed_layout || 'grid';
const showTitles = gallery.show_titles !== false;

// 5. LAYOUT HELPERS
const wrapperClass =
  layout === 'masonry'
    ? 'columns-1 md:columns-2 lg:columns-3 gap-8 [column-fill:_balance]'
    : layout === 'bento'
      ? 'grid grid-cols-1 md:grid-cols-6 gap-8'
      : 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8';

const cardBase =
  'group relative overflow-hidden rounded-[var(--radius)] bg-[var(--bg-card)] border border-[var(--border)]';

function bentoSpan(i: number) {
  const k = i % 6;
  if (k === 0) return 'md:col-span-4 md:row-span-2';
  if (k === 1) return 'md:col-span-2 md:row-span-1';
  if (k === 2) return 'md:col-span-2 md:row-span-1';
  if (k === 3) return 'md:col-span-3 md:row-span-1';
  if (k === 4) return 'md:col-span-3 md:row-span-1';
  return 'md:col-span-6 md:row-span-1';
}

function aspectClass(i: number) {
  if (layout === 'bento') {
    const k = i % 6;
    return k === 0 ? 'min-h-[420px]' : 'min-h-[220px]';
  }
  if (layout === 'masonry') {
    return i % 3 === 0 ? 'min-h-[400px]' : i % 3 === 1 ? 'min-h-[300px]' : 'min-h-[350px]';
  }
  return 'aspect-video';
}
---

<section id="gallery" class="py-24 bg-[var(--bg-color)] scroll-mt-20">
  <div class="container mx-auto px-6 mb-12 text-center">
    <h2 class="text-4xl md:text-5xl font-black uppercase text-[var(--text-primary)]">
      {title.split(' ').slice(0, -1).join(' ') || title}{' '}
      <span class="text-[var(--accent)]">{title.split(' ').slice(-1)[0]}</span>
    </h2>
  </div>

  <div class={`container mx-auto px-6 ${wrapperClass}`}>
    {visibleItems.map((item: any, index: number) => {
      // Matches the filename logic in fetch-unsplash-images.mjs [cite: 14]
      const expectedFilename = `${brandSlug}-project-${index}.jpg`;
      const imagePath = `/src/assets/images/${expectedFilename}`;
      const hasImage = images[imagePath];

      const bentoClass = layout === 'bento' ? bentoSpan(index) : '';
      const sizeClass = aspectClass(index);
      const masonryCardExtras = layout === 'masonry' ? 'mb-8 inline-block w-full break-inside-avoid' : '';

      return (
        <div class={`${layout === 'bento' ? bentoClass : ''} ${masonryCardExtras}`}>
          <div class={`${cardBase} ${sizeClass}`}>
            {hasImage ? (
              <Image
                src={images[imagePath]()}
                alt={item.title || 'Gallery Image'}
                width={1200}
                height={800}
                class="object-cover w-full h-full transition-transform duration-700 group-hover:scale-110"
              />
            ) : (
              <div class="flex flex-col items-center justify-center h-full bg-slate-900/50 p-6 border-2 border-dashed border-white/10">
                <span class="text-red-400 font-mono text-xs mb-2 text-center">Missing: {expectedFilename}</span>
                <span class="text-[10px] text-white/20 uppercase tracking-widest">Image Factory Syncing...</span>
              </div>
            )}

            {showTitles && (item.title || item.description) && (
              <div class="absolute inset-0 bg-gradient-to-t from-[var(--bg-color)] via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-all duration-500 flex flex-col justify-end p-8">
                <p class="text-[var(--accent)] font-black uppercase tracking-widest text-sm mb-2">
                  {item.title}
                </p>
                {item.description && (
                   <p class="text-[var(--text-secondary)] text-xs line-clamp-2">
                    {item.description}
                  </p>
                )}
              </div>
            )}
          </div>
        </div>
      );
    })}
  </div>
</section>