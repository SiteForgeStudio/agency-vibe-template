---
import { Image } from 'astro:assets';

const { brand, gallery, id, strategy, intelligence } = Astro.props;

const allImages = import.meta.glob(
  '/src/assets/generated/*/*.{jpg,jpeg,png,webp}',
  { eager: true }
);

const clientImageEntries = Object.entries(allImages).filter(([path]) =>
  path.includes(`/generated/${id}/`)
);

const galleryItems = (gallery?.items || [])
  .map((item: any, index: number) => {

    const fileName = `${brand?.slug || id}-project-${index}`;

    const match = clientImageEntries.find(([path]) =>
      path.includes(fileName)
    );

    return {
      ...item,
      imageAsset: match?.[1]?.default || null
    };

  })
  .filter(item => item.imageAsset);

/**
 * STRATEGY DETECTION
 */
const mode =
  strategy?.positioning === "luxury" ? "cinematic" :
  strategy?.showcase_style === "editorial" ? "masonry" :
  galleryItems.length <= 3 ? "showcase" :
  "grid";

/**
 * INDUSTRY ASPECT RATIO
 */
const aspect =
  intelligence?.industry === "Landscaping" ? "aspect-[4/3]" :
  intelligence?.industry === "Interior Design" ? "aspect-[3/4]" :
  "aspect-square";
---

<section id="gallery" class="py-28 bg-[var(--bg-primary)]">

  <div class="container mx-auto px-6">

    <div class="mb-16">
      <h2 class="text-4xl md:text-5xl font-black uppercase tracking-tight text-[var(--text-primary)]">
        {gallery?.title || "Selected Work"}
      </h2>
      <div class="h-[2px] w-16 bg-[var(--accent)] mt-5"></div>
    </div>

    {/* MODE: CINEMATIC */}
    {mode === "cinematic" && (
      <div class="grid grid-cols-1 md:grid-cols-12 gap-6">

        {galleryItems.map((item: any, index: number) => {

          const span =
            index === 0 ? "md:col-span-8" : "md:col-span-4";

          return (
            <div class={`group relative overflow-hidden rounded-xl border border-[var(--border)] ${span}`}>

              <div class={`overflow-hidden ${aspect}`}>

                <Image
                  src={item.imageAsset}
                  alt={item.title}
                  width={1200}
                  height={900}
                  class="object-cover w-full h-full transition-transform duration-1000 group-hover:scale-105"
                />

              </div>

              <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>

              <div class="absolute bottom-6 left-6 text-white opacity-0 group-hover:opacity-100 transition-all duration-500">

                <h3 class="text-xl font-bold uppercase tracking-tight">
                  {item.title}
                </h3>

                <p class="text-sm opacity-80">
                  {item.tag}
                </p>

              </div>

            </div>
          );
        })}

      </div>
    )}

    {/* MODE: GRID */}
    {mode === "grid" && (
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

        {galleryItems.map((item: any) => (

          <div class="group relative overflow-hidden bg-[var(--bg-card)] border border-[var(--border)] rounded-xl">

            <div class={`overflow-hidden ${aspect}`}>

              <Image
                src={item.imageAsset}
                alt={item.title}
                width={800}
                height={800}
                class="object-cover w-full h-full transition-transform duration-700 group-hover:scale-110"
              />

            </div>

            <div class="p-6">
              <h3 class="text-lg font-bold uppercase tracking-tight text-[var(--text-primary)]">
                {item.title}
              </h3>

              <p class="text-sm text-[var(--text-secondary)] opacity-70 mt-1">
                {item.tag}
              </p>
            </div>

          </div>

        ))}

      </div>
    )}

    {/* MODE: SHOWCASE */}
    {mode === "showcase" && (
      <div class="space-y-10">

        {galleryItems.map((item: any) => (

          <div class="group overflow-hidden rounded-xl border border-[var(--border)]">

            <div class={`overflow-hidden ${aspect}`}>

              <Image
                src={item.imageAsset}
                alt={item.title}
                width={1200}
                height={900}
                class="object-cover w-full h-full transition-transform duration-1000 group-hover:scale-105"
              />

            </div>

            <div class="p-8 bg-[var(--bg-card)]">
              <h3 class="text-2xl font-bold text-[var(--text-primary)]">
                {item.title}
              </h3>
              <p class="text-sm text-[var(--text-secondary)] mt-2">
                {item.tag}
              </p>
            </div>

          </div>

        ))}

      </div>
    )}

  </div>

</section>