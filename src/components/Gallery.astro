---
import { Image } from 'astro:assets';
const { gallery, brand } = Astro.props;

// 1. ASSET DISCOVERY
// This scans your images folder so Astro can optimize them at build time.
const images = import.meta.glob<{ default: ImageMetadata }>('/src/assets/images/*.{jpeg,jpg,png,gif,webp}');

// 2. THE SLUG HANDSHAKE
// Ensures we are looking for "heritage-watch-test-project-0.jpg" instead of a generic name.
const brandSlug =
  brand?.slug ||
  (brand?.name || 'brand')
    .toLowerCase()
    .replace(/'/g, '')
    .replace(/[^a-z0-9]/g, '-');

// 3. BULLETPROOF GUARD
// Only hide if the gallery is explicitly disabled or there is zero count/items.
const items = Array.isArray(gallery?.items) ? gallery.items : [];
const count = gallery?.computed_count || items.length;

if (!gallery || gallery.enabled === false || (items.length === 0 && count === 0)) {
  return null;
}

// 4. DATA PREPARATION
// If the AI provided a count but no items, we create a skeleton array so the loop still runs.
const visibleItems = items.length > 0 
  ? items.slice(0, count) 
  : Array.from({ length: count }).map((_, i) => ({ title: `Project ${i + 1}` }));

const title = gallery.title || 'The Lab';
const layout = gallery.computed_layout || 'grid';
const showTitles = gallery.show_titles !== false;

// 5. LAYOUT HELPERS
const wrapperClass =
  layout === 'masonry'
    ? 'columns-1 md:columns-2 gap-8 [column-fill:_balance]'
    : layout === 'bento'
      ? 'grid grid-cols-1 md:grid-cols-6 gap-8'
      : 'grid grid-cols-1 md:grid-cols-2 gap-8';

const cardBase =
  'group relative overflow-hidden rounded-[var(--radius)] bg-[var(--bg-card)] border border-[var(--border)]';

function bentoSpan(i: number) {
  const k = i % 6;
  if (k === 0) return 'md:col-span-4 md:row-span-2';
  if (k === 1) return 'md:col-span-2 md:row-span-1';
  if (k === 2) return 'md:col-span-2 md:row-span-1';
  if (k === 3) return 'md:col-span-3 md:row-span-1';
  if (k === 4) return 'md:col-span-3 md:row-span-1';
  return 'md:col-span-6 md:row-span-1';
}

function aspectClass(i: number) {
  if (layout === 'bento') {
    const k = i % 6;
    return k === 0 ? 'min-h-[420px]' : 'min-h-[220px]';
  }
  if (layout === 'masonry') {
    return i % 3 === 0 ? 'min-h-[360px]' : i % 3 === 1 ? 'min-h-[260px]' : 'min-h-[300px]';
  }
  return 'aspect-video';
}
---

<section id="gallery" class="py-24 bg-[var(--bg-color)]">
  <div class="container mx-auto px-6 mb-12 text-center">
    <h2 class="text-4xl font-black uppercase text-[var(--text-primary)]">
      {title.split(' ').slice(0, -1).join(' ') || title}{' '}
      <span class="text-[var(--accent)]">{title.split(' ').slice(-1)[0]}</span>
    </h2>
  </div>

  <div class={`container mx-auto px-6 ${wrapperClass}`}>
    {visibleItems.map((item: any, index: number) => {
      // Matches the filename generated by your fetch-unsplash-images.mjs
      const expectedFilename = `${brandSlug}-project-${index}.jpg`;
      const imagePath = `/src/assets/images/${expectedFilename}`;
      const hasImage = images[imagePath];

      const bentoClass = layout === 'bento' ? bentoSpan(index) : '';
      const sizeClass = aspectClass(index);
      const masonryCardExtras = layout === 'masonry' ? 'mb-8 inline-block w-full break-inside-avoid' : '';

      return (
        <div class={`${layout === 'bento' ? bentoClass : ''} ${masonryCardExtras}`}>
          <div class={`${cardBase} ${sizeClass}`}>
            {hasImage ? (
              <Image
                src={images[imagePath]()}
                alt={item.title || 'Gallery Image'}
                width={1200}
                height={800}
                class="object-cover w-full h-full transition-transform duration-700 group-hover:scale-105"
              />
            ) : (
              <div class="flex flex-col items-center justify-center h-full bg-slate-900 p-4">
                <span class="text-red-500 font-mono text-xs mb-2 text-center">Missing: {expectedFilename}</span>
                <span class="text-[10px] text-white/30 uppercase">Build in progress...</span>
              </div>
            )}

            {showTitles && item.title && (
              <div class="absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black/90 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                <p class="text-white font-bold uppercase tracking-widest text-sm">
                  {item.title}
                </p>
              </div>
            )}
          </div>
        </div>
      );
    })}
  </div>
</section>