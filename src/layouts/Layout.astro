---
/**
 * Main Layout - 2026 High-Performance Vibe Engine
 * Strategy: Tenant-Blind Handshake (Environment Variable Driven)
 */
 import { getClientData } from '../lib/dataFetcher';
import '../styles/vibe-system.css';

interface Props {
    title?: string;
    vibeOverride?: string;
    settings?: any; // Added to receive settings from index.astro
}

const { title, vibeOverride } = Astro.props;

// 1. DYNAMIC DATA FETCH (No more hardcoded imports)
const data = getClientData();
if (!data) throw new Error("Layout failed to fetch client data.");

// 2. VIBE NORMALIZATION
const rawVibe = vibeOverride || data.settings?.vibe || 'midnight-tech';
const activeVibe = rawVibe.toLowerCase().replace(/\s+/g, '-');

const vibeLibrary = {
  'midnight-tech': { accent: '#00f2ff', bg: '#020617', text: '#f8fafc', radius: '4px', font: "'JetBrains Mono', monospace" },
  'zenith-earth': { accent: '#10b981', bg: '#f0fdf4', text: '#064e3b', radius: '24px', font: "'Outfit', sans-serif" },
  'vintage-boutique': { accent: '#b45309', bg: '#fffbeb', text: '#451a03', radius: '12px', font: "'Cormorant Garamond', serif" },
  'rugged-industrial': { accent: '#f97316', bg: '#000000', text: '#ffffff', radius: '0px', font: "'Inter', sans-serif" },
  'modern-minimal': { accent: '#6366f1', bg: '#ffffff', text: '#1e293b', radius: '8px', font: "'Inter', sans-serif" },
  'luxury-noir': { accent: '#D4AF37', bg: '#050505', text: '#ffffff', radius: '2px', font: "'Cormorant Garamond', serif" },
  'legacy-professional': { accent: '#1e40af', bg: '#ffffff', text: '#0f172a', radius: '6px', font: "'Inter', sans-serif" },
  'solar-flare': { accent: '#fbbf24', bg: '#0f172a', text: '#f8fafc', radius: '16px', font: "'Outfit', sans-serif" }
};

const config = vibeLibrary[activeVibe] || vibeLibrary['midnight-tech'];

// 3. DYNAMIC SEO & SCHEMA
const seoTitle = title || `${data.brand.name} | ${data.brand.tagline || 'Professional Services'}`;
const seoDescription = data.brand.objection_handle || data.brand.tagline || "Professional services you can trust.";

const ldJson = {
  "@context": "https://schema.org",
  "@type": data.intelligence?.industry?.includes('Music') ? "EventVenue" : "LocalBusiness",
  "name": data.brand.name,
  "description": data.brand.tagline,
  "url": data.settings?.site_url || "#"
};
---

<!doctype html>
<html lang="en" data-vibe={activeVibe}>
    <head>
        <meta charset="UTF-8" />
        <meta name="description" content={seoDescription} />
        <meta name="viewport" content="width=device-width" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <title>{seoTitle}</title>

        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link 
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@400;800&family=Cormorant+Garamond:ital,wght@0,400;0,700;1,700&family=Outfit:wght@400;900&display=swap" 
            rel="stylesheet" 
        />

        <script type="application/ld+json" set:html={JSON.stringify(ldJson)} />

        <style define:vars={{ 
            'v-accent': config.accent,
            'v-bg': config.bg,
            'v-text': config.text,
            'v-radius': config.radius,
            'v-font': config.font
        }}>
            :root {
                --accent: var(--v-accent);
                --bg-color: var(--v-bg);
                --text-primary: var(--v-text);
                --radius: var(--v-radius);
                --font-main: var(--v-font);
                
                --bg-card: color-mix(in srgb, var(--bg-color) 90%, var(--accent));
                --border: color-mix(in srgb, var(--accent) 25%, transparent);
                --text-secondary: color-mix(in srgb, var(--text-primary) 70%, transparent);
            }
        </style>
    </head>
    <body class="bg-[var(--bg-color)] text-[var(--text-primary)] font-[var(--font-main)] transition-colors duration-500 selection:bg-[var(--accent)] selection:text-[var(--bg-color)]">
        
        <slot />

        {/* NOTE: Redundant Footer removed here. 
            Footer is now managed exclusively by index.astro 
        */}
        
        <style is:global>
            html { scroll-behavior: smooth; }
            body { font-family: var(--font-main) !important; }
            h1, h2, h3, h4, .brand-heading {
                font-weight: 900;
                letter-spacing: -0.04em;
                text-transform: uppercase;
                line-height: 0.9;
            }
            img, .vibe-container {
                border-radius: var(--radius);
            }
        </style>
    </body>
</html>